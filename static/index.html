<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Go Shop</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: sans-serif; margin: 0; background: #f8fafc; }
header { background: #ffffffcc; backdrop-filter: blur(6px); position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
header h1 { font-size: 1.5rem; color: #059669; margin: 0; }
header button { border: none; padding: 5px 10px; border-radius: 10px; cursor: pointer; font-weight: bold; margin-left: 5px; color: white; transition: 0.2s; }
header button.add { background: #059669; }
header button.cart { background: #111827; }
main { padding: 20px; max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fill,minmax(250px,1fr)); gap: 20px; }

.product { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); display: flex; flex-direction: column; opacity: 0; transform: translateY(20px); transition: all 0.4s ease, transform 0.3s ease; }
.product.show { opacity: 1; transform: translateY(0); }
.product:hover { transform: translateY(-5px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }

.product h3 { margin: 0; font-size: 1.2rem; color: #111827; }
.product p { margin: 4px 0; color: #6b7280; font-size: 0.9rem; }
.badge { display: inline-block; padding: 2px 6px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; background: #fef3c7; color: #b45309; margin-top: 4px; }

.product .buttons {
  margin-top: auto;
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  justify-content: space-between;
}

.product .buttons button { 
  padding: 6px 10px; 
  border-radius: 6px; 
  font-weight: bold; 
  border: none; 
  cursor: pointer; 
  transition: 0.2s; 
  font-size: 0.8rem; 
  white-space: nowrap;
  flex: 1;
  min-width: 70px;
}
.btn-add { background: #059669; color: white; }
.btn-edit { background: #f97316; color: white; }
.btn-delete { background: #dc2626; color: white; }
.btn-add:hover { background: #047857; }
.btn-edit:hover { background: #ea580c; }
.btn-delete:hover { background: #b91c1c; }

/* CART DRAWER */
.cart-drawer { position: fixed; top: 0; right: -100%; width: 360px; height: 100%; background: white; box-shadow: -2px 0 8px rgba(0,0,0,0.2); transition: right 0.4s ease; z-index: 200; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; }
.cart-drawer.open { right: 0; }
.cart-drawer h2 { margin-top: 0; margin-bottom: 16px; }
.cart-items { display: flex; flex-direction: column; gap: 10px; overflow-x: hidden; padding-bottom: 10px; }
.cart-total { margin-top: auto; font-weight: bold; font-size: 1.2rem; text-align: right; padding: 10px; background: #f8fafc; border-radius: 8px; }
.overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); opacity: 0; pointer-events: none; transition: opacity 0.3s ease; z-index: 150; }
.overlay.show { opacity: 1; pointer-events: all; }

/* MODAL ADD/EDIT PRODUCT */
#product-modal { display:none; position:fixed; inset:0; background:#000000aa; justify-content:center; align-items:center; z-index:300; }
#product-modal > div { background:white; padding:20px; border-radius:12px; width:300px; display:flex; flex-direction:column; gap:8px; }
#product-modal input { padding:6px; border-radius:6px; border:1px solid #ccc; width:100%; }
#product-modal button { padding:6px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
#product-modal button.submit { background:#059669; color:white; }
#product-modal button.cancel { background:#dc2626; color:white; }

/* Стили для управления количеством в корзине */
.cart-item-controls {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 8px;
}

.cart-item-controls button {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  border: none;
  background: #059669;
  color: white;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.cart-item-controls .quantity {
  font-weight: bold;
  min-width: 30px;
  text-align: center;
}
</style>
</head>
<body>
<header>
  <h1>Go Shop</h1>
  <div>
    <button class="add" onclick="openAddProduct()">Добавить товар</button>
    <button class="cart" onclick="toggleCart()">Корзина (<span id="cart-count">0</span>)</button>
  </div>
</header>

<main id="products"></main>

<!-- CART DRAWER -->
<div class="overlay" id="cart-overlay" onclick="toggleCart()"></div>
<div class="cart-drawer" id="cart-drawer">
  <h2>Корзина</h2>
  <div class="cart-items" id="cart-items"></div>
  <div class="cart-total" id="cart-total">Итого: 0 ₽</div>
</div>

<!-- MODAL ADD/EDIT PRODUCT -->
<div id="product-modal">
  <div>
    <h3 id="modal-title">Добавить товар</h3>
    <input id="new-name" placeholder="Название">
    <input id="new-desc" placeholder="Описание">
    <input id="new-price" type="number" placeholder="Цена">
    <input id="new-qty" type="number" placeholder="Количество">
    <button class="submit" onclick="submitProduct()">Сохранить</button>
    <button class="cancel" onclick="closeProductModal()">Отмена</button>
  </div>
</div>

<script>
const API_BASE = 'http://localhost:8080';
let products = [];
let cart = [];
let editProductId = null;

async function fetchJSON(url, options={}) {
  try {
    const res = await fetch(url, options);
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  } catch (error) {
    console.error('Fetch error:', error);
    throw error;
  }
}

// ------------------- LOAD -------------------
async function loadProducts() {
  try {
    products = await fetchJSON(API_BASE + '/products');
    renderProducts();
  } catch (error) {
    console.error('Failed to load products:', error);
  }
}

async function loadCart() {
  try {
    cart = await fetchJSON(API_BASE + '/cart');
    renderCart();
    await updateCartTotal();
  } catch (error) {
    console.error('Failed to load cart:', error);
  }
}

// Функция для получения общей суммы корзины
async function getCartTotal() {
  try {
    const response = await fetchJSON(API_BASE + '/cart/total');
    return response.total;
  } catch (error) {
    console.error('Error getting cart total, calculating locally:', error);
    return cart.reduce((total, item) => total + (item.price * item.quantity), 0);
  }
}

// Функция для обновления отображения итога
async function updateCartTotal() {
  try {
    const total = await getCartTotal();
    const cartTotalElement = document.getElementById('cart-total');
    if (cartTotalElement) {
      cartTotalElement.textContent = 'Итого: ' + total.toLocaleString('ru-RU') + ' ₽';
    }
  } catch (error) {
    console.error('Error updating cart total:', error);
    const localTotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
    document.getElementById('cart-total').textContent = 'Итого: ' + localTotal.toLocaleString('ru-RU') + ' ₽';
  }
}

// ------------------- RENDER -------------------
function renderProducts() {
  const container = document.getElementById('products');
  container.innerHTML = '';
  products.forEach(p => {
    const div = document.createElement('div');
    div.className = 'product';
    div.innerHTML = `
      <h3>${p.name}</h3>
      <p>${p.description}</p>
      <p><b>${p.price.toLocaleString('ru-RU')} ₽</b></p>
      ${p.quantity < 10 ? `<span class="badge">Осталось мало</span>` : ''}
      <p>На складе: ${p.quantity}</p>
      <div class="buttons">
        <button class="btn-add" onclick="addToCart(${p.id},1)" ${p.quantity<=0?'disabled':''}>В корзину</button>
        <button class="btn-edit" onclick="openEditProduct(${p.id})">Редактировать</button>
        <button class="btn-delete" onclick="deleteProduct(${p.id})">Удалить</button>
      </div>
    `;
    container.appendChild(div);
    setTimeout(() => div.classList.add('show'), 50);
  });
}

function renderCart() {
  const itemsContainer = document.getElementById('cart-items');
  itemsContainer.innerHTML = '';
  
  if (cart.length === 0) {
    itemsContainer.innerHTML = '<p>Корзина пуста</p>';
    document.getElementById('cart-count').textContent = '0';
    return;
  }
  
  // Группируем товары по product_id
  const cartItemsMap = {};
  cart.forEach(item => {
    if (!cartItemsMap[item.product_id]) {
      cartItemsMap[item.product_id] = { ...item, quantity: 0 };
    }
    cartItemsMap[item.product_id].quantity += item.quantity;
  });
  
  // Отображаем сгруппированные товары
  Object.values(cartItemsMap).forEach(item => {
    const div = document.createElement('div');
    div.className = 'product';
    div.style.minWidth = '200px';
    div.innerHTML = `
      <h3>${item.name}</h3>
      <p>${item.description}</p>
      <p><b>${item.price.toLocaleString('ru-RU')} ₽ × ${item.quantity}</b></p>
      <div class="cart-item-controls">
        <button onclick="updateCartQuantity(${item.product_id}, ${item.quantity - 1})">-</button>
        <span class="quantity">${item.quantity}</span>
        <button onclick="updateCartQuantity(${item.product_id}, ${item.quantity + 1})">+</button>
      </div>
      <div class="buttons">
        <button class="btn-delete" onclick="removeFromCart(${item.product_id})">Удалить все</button>
      </div>
    `;
    itemsContainer.appendChild(div);
    setTimeout(() => div.classList.add('show'), 50);
  });
  
  document.getElementById('cart-count').textContent = Object.keys(cartItemsMap).length.toString();
}

// ------------------- CART -------------------
async function addToCart(productId, qty) {
  try {
    await fetchJSON(API_BASE + '/cart', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({product_id: productId, quantity: qty})
    });
    await loadProducts();
    await loadCart();
  } catch (error) {
    console.error('Error adding to cart:', error);
  }
}

async function updateCartQuantity(productId, newQuantity) {
  try {
    if (newQuantity <= 0) {
      await removeFromCart(productId);
      return;
    }
    
    // Сначала удаляем все экземпляры товара
    await fetchJSON(API_BASE + '/cart/' + productId, {method:'DELETE'});
    
    // Затем добавляем новое количество
    if (newQuantity > 0) {
      await fetchJSON(API_BASE + '/cart', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({product_id: productId, quantity: newQuantity})
      });
    }
    
    await loadProducts();
    await loadCart();
  } catch (error) {
    console.error('Error updating cart quantity:', error);
  }
}

async function removeFromCart(productId) {
  try {
    await fetchJSON(API_BASE + '/cart/' + productId, {method:'DELETE'});
    await loadProducts();
    await loadCart();
  } catch (error) {
    console.error('Error removing from cart:', error);
  }
}

// ------------------- PRODUCTS -------------------
async function deleteProduct(productId) {
  try {
    await fetchJSON(API_BASE + '/products/' + productId, {method:'DELETE'});
    await loadProducts();
    await loadCart();
  } catch (error) {
    console.error('Error deleting product:', error);
  }
}

function openAddProduct() {
  editProductId = null;
  document.getElementById('modal-title').textContent = 'Добавить товар';
  document.getElementById('new-name').value = '';
  document.getElementById('new-desc').value = '';
  document.getElementById('new-price').value = '';
  document.getElementById('new-qty').value = '';
  document.getElementById('product-modal').style.display = 'flex';
}

function openEditProduct(id) {
  editProductId = id;
  const p = products.find(x => x.id === id);
  if (!p) return;
  document.getElementById('modal-title').textContent = 'Редактировать товар';
  document.getElementById('new-name').value = p.name;
  document.getElementById('new-desc').value = p.description;
  document.getElementById('new-price').value = p.price;
  document.getElementById('new-qty').value = p.quantity;
  document.getElementById('product-modal').style.display = 'flex';
}

function closeProductModal() {
  document.getElementById('product-modal').style.display = 'none';
  editProductId = null;
}

async function submitProduct() {
  const name = document.getElementById('new-name').value;
  const description = document.getElementById('new-desc').value;
  const price = parseFloat(document.getElementById('new-price').value);
  const quantity = parseInt(document.getElementById('new-qty').value);

  if (!name || !description || isNaN(price) || isNaN(quantity)) {
    alert('Заполните все поля корректно');
    return;
  }

  try {
    if (editProductId) {
      await fetchJSON(API_BASE + '/products/' + editProductId, {
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({name, description, price, quantity})
      });
    } else {
      await fetchJSON(API_BASE + '/products', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({name, description, price, quantity})
      });
    }

    closeProductModal();
    await loadProducts();
    await loadCart();
  } catch (error) {
    console.error('Error submitting product:', error);
    alert('Ошибка при сохранении товара');
  }
}

// ------------------- UI -------------------
function toggleCart() {
  const drawer = document.getElementById('cart-drawer');
  const overlay = document.getElementById('cart-overlay');
  const open = drawer.classList.contains('open');
  if(open) {
    drawer.classList.remove('open');
    overlay.classList.remove('show');
  } else {
    drawer.classList.add('open');
    overlay.classList.add('show');
  }
}

function openCart() { 
  document.getElementById('cart-drawer').classList.add('open'); 
  document.getElementById('cart-overlay').classList.add('show'); 
}

// ------------------- INITIAL LOAD -------------------
document.addEventListener('DOMContentLoaded', function() {
  loadProducts();
  loadCart();
});
</script>
</body>
</html>